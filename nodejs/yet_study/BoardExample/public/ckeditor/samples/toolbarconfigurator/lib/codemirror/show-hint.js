(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],f):f(CodeMirror)})(function(f){function p(a,c,b){this.cm=a;this.getHints=c;this.options=b;this.widget=this.onClose=null}function v(a,c){function b(a,b){var d;d="string"!=typeof b?function(a){return b(a,c)}:e.hasOwnProperty(b)?e[b]:b;f[a]=d}var e={Up:function(){c.moveFocus(-1)},Down:function(){c.moveFocus(1)},PageUp:function(){c.moveFocus(-c.menuSize()+
1,!0)},PageDown:function(){c.moveFocus(c.menuSize()-1,!0)},Home:function(){c.setFocus(0)},End:function(){c.setFocus(c.length-1)},Enter:c.pick,Tab:c.pick,Esc:c.close},f=a.customKeys?{}:e;if(a.customKeys)for(var d in a.customKeys)a.customKeys.hasOwnProperty(d)&&b(d,a.customKeys[d]);if(a.extraKeys)for(d in a.extraKeys)a.extraKeys.hasOwnProperty(d)&&b(d,a.extraKeys[d]);return f}function s(a,c){for(;c&&c!=a;){if("LI"===c.nodeName.toUpperCase()&&c.parentNode==a)return c;c=c.parentNode}}function m(a,c){this.completion=
a;this.data=c;var b=this,e=a.cm,i=a.options,d=this.hints=document.createElement("ul");d.className="CodeMirror-hints"+(i.hintsClass?" "+i.hintsClass:"");this.selectedHint=i.getDefaultSelection?i.getDefaultSelection(e,i,c):0;for(var g=c.list,j=0;j<g.length;++j){var l=d.appendChild(document.createElement("li")),h=g[j],k=w+(j!=this.selectedHint?"":" "+q);null!=h.className&&(k=h.className+" "+k);l.className=k;h.render?h.render(l,c,h):l.appendChild(document.createTextNode(h.displayText||("string"==typeof h?
h:h.text)));l.hintId=j}var j=e.cursorCoords(!1!==i.alignWithWord?c.from:null),n=j.left,o=j.bottom,t=!0;d.style.left=n+"px";d.style.top=o+"px";l=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);k=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(i.container||document.body).appendChild(d);h=d.getBoundingClientRect();if(0<h.bottom-k){var r=h.bottom-h.top,m=h.top-(j.bottom-j.top);0<m-r?(d.style.top=(o=m-r)+"px",t=
!1):r>k&&(d.style.height=k-5+"px",d.style.top=(o=j.bottom-h.top)+"px",k=e.getCursor(),c.from.ch!=k.ch&&(j=e.cursorCoords(k),d.style.left=(n=j.left)+"px",h=d.getBoundingClientRect()))}k=h.left-l;0<k&&(h.right-h.left>l&&(d.style.width=l-5+"px",k-=h.right-h.left-l),d.style.left=(n=j.left-k)+"px");e.addKeyMap(this.keyMap=v(i,{moveFocus:function(a,c){b.changeActive(b.selectedHint+a,c)},setFocus:function(a){b.changeActive(a)},menuSize:function(){return b.screenAmount()},length:g.length,close:function(){a.close()},
pick:function(){b.pick()},data:c}));if(!1!==i.closeOnUnfocus){var p;e.on("blur",this.onBlur=function(){p=setTimeout(function(){a.close()},100)});e.on("focus",this.onFocus=function(){clearTimeout(p)})}var u=e.getScrollInfo();e.on("scroll",this.onScroll=function(){var b=e.getScrollInfo(),c=e.getWrapperElement().getBoundingClientRect(),f=o+u.top-b.top,g=f-(window.pageYOffset||(document.documentElement||document.body).scrollTop);t||(g=g+d.offsetHeight);if(g<=c.top||g>=c.bottom)return a.close();d.style.top=
f+"px";d.style.left=n+u.left-b.left+"px"});f.on(d,"dblclick",function(a){if((a=s(d,a.target||a.srcElement))&&a.hintId!=null){b.changeActive(a.hintId);b.pick()}});f.on(d,"click",function(a){if((a=s(d,a.target||a.srcElement))&&a.hintId!=null){b.changeActive(a.hintId);i.completeOnSingleClick&&b.pick()}});f.on(d,"mousedown",function(){setTimeout(function(){e.focus()},20)});f.signal(c,"select",g[0],d.firstChild);return!0}var w="CodeMirror-hint",q="CodeMirror-hint-active";f.showHint=function(a,c,b){if(null==
c){if(b&&b.async)return;c=f.hint.auto}a.state.completionActive&&a.state.completionActive.close();var e=a.state.completionActive=new p(a,c,b||{});f.signal(a,"startCompletion",a);if(e.options.async)c(a,function(a){e.showHints(a)},e.options);else return e.showHints(c(a,e.options))};p.prototype={close:function(a){if(this.active()){this.cm.state.completionActive=null;this.widget&&this.widget.close();if(this.onClose)this.onClose();f.signal(this.cm,"endCompletion",this.cm,a)}},active:function(){return this.cm.state.completionActive==
this},pick:function(a,c){var b=a.list[c];b.hint?b.hint(this.cm,a,b):this.cm.replaceRange("string"==typeof b?b:b.text,b.from||a.from,b.to||a.to);f.signal(a,"pick",b);this.close(a)},showHints:function(a){if(!a||!a.list.length||!this.active())return this.close(a);!1!=this.options.completeSingle&&1==a.list.length?this.pick(a,0):this.showWidget(a)},showWidget:function(a){function c(){j||(j=!0,g.close(a),g.cm.off("cursorActivity",i),a&&f.signal(a,"close"))}function b(){j||(f.signal(a,"update"),g.options.async?
g.getHints(g.cm,e,g.options):e(g.getHints(g.cm,g.options)))}function e(b){a=b;if(!j){if(!a||!a.list.length)return c();g.widget&&g.widget.close();g.widget=new m(g,a)}}function i(){d&&(o(d),d=0);var a=g.cm.getCursor(),c=g.cm.getLine(a.line);a.line!=h.line||c.length-a.ch!=k-h.ch||a.ch<h.ch||g.cm.somethingSelected()||a.ch&&l.test(c.charAt(a.ch-1))?g.close():(d=n(b),g.widget&&g.widget.close())}this.widget=new m(this,a);f.signal(a,"shown");var d=0,g=this,j,l=this.options.closeCharacters||/[\s()\[\]{};:>,]/,
h=this.cm.getCursor(),k=this.cm.getLine(h.line).length,n=window.requestAnimationFrame||function(a){return setTimeout(a,1E3/60)},o=window.cancelAnimationFrame||clearTimeout;this.cm.on("cursorActivity",i);this.onClose=c}};m.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var a=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(a.off("blur",this.onBlur),a.off("focus",
this.onFocus));a.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(a,c){a>=this.data.list.length?a=c?this.data.list.length-1:0:0>a&&(a=c?0:this.data.list.length-1);if(this.selectedHint!=a){var b=this.hints.childNodes[this.selectedHint];b.className=b.className.replace(" "+q,"");b=this.hints.childNodes[this.selectedHint=a];b.className+=" "+q;b.offsetTop<this.hints.scrollTop?this.hints.scrollTop=b.offsetTop-3:b.offsetTop+b.offsetHeight>
this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=b.offsetTop+b.offsetHeight-this.hints.clientHeight+3);f.signal(this.data,"select",this.data.list[this.selectedHint],b)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};f.registerHelper("hint","auto",function(a,c){var b=a.getHelpers(a.getCursor(),"hint");if(b.length)for(var e=0;e<b.length;e++){var i=b[e](a,c);if(i&&i.list.length)return i}else if(b=a.getHelper(a.getCursor(),
"hintWords")){if(b)return f.hint.fromList(a,{words:b})}else if(f.hint.anyword)return f.hint.anyword(a,c)});f.registerHelper("hint","fromList",function(a,c){for(var b=a.getCursor(),e=a.getTokenAt(b),i=[],d=0;d<c.words.length;d++){var g=c.words[d];g.slice(0,e.string.length)==e.string&&i.push(g)}if(i.length)return{list:i,from:f.Pos(b.line,e.start),to:f.Pos(b.line,e.end)}});f.commands.autocomplete=f.showHint});